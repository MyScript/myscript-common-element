<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="./myscriptjs-import.html">
<!--
`myscript-languages-element` is a web component to retrieve CDK available languages.

    <myscript-languages-element
        applicationkey="YOUR MYSCRIPT CDK APPLICATION KEY"
        hmackey="YOUR MYSCRIPT CDK HMAC KEY">
    </myscript-languages-element>

@demo demo/get_languages.html Get languages
@demo demo/get_languages_programmatic.html Get languages programmatically
-->
<dom-module id="myscript-languages-element">
    <template>
        <style>
            :host {
                contain: content;
                box-sizing: border-box;
                display: inline-block;
            }

            [hidden] {
                display: none !important;
            }

            select {
                -webkit-appearance: none;
                -moz-appearance: none;
                width: auto;
                padding: .375rem 1.75rem .4375rem .75rem;
                color: #131F26;
                background: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgiIGhlaWdodD0iMTQiIHZpZXdCb3g9IjAgMCAxOCAxNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxwYXRoIGQ9Ik00LjQyMi4yNmMtLjIzMy0uMzM3LS42MS0uMzM3LS44NDQgMEwuMTc1IDUuMTdDLS4xNDIgNS42MjguMDQ4IDYgLjYxIDZoNi43OGMuNTU4IDAgLjc1NC0uMzcuNDM1LS44M0w0LjQyMi4yNnptLjAyIDEzLjQ3Yy0uMjM2LjM0Mi0uNjE4LjM0Ny0uODUuMDFMLjE2NyA4LjgxOEMtLjE0NiA4LjM2Ny4wNDggOCAuNjA4IDhoNi43ODNjLjU1OCAwIC43NTUuMzcuNDM3LjgzbC0zLjM4NSA0Ljl6IiBmaWxsPSIjMTMxRjI2Ii8+PC9nPjwvc3ZnPg==) right center no-repeat #fff;
                -webkit-appearance: none;
                appearance: none;
                height: 2.625rem;
                font: 400 1.125rem "Source Sans Pro", sans-serif;
                border: 1px solid #CED5D9;
                border-radius: 3px;
                -webkit-tap-highlight-color: transparent;
            }
        </style>
        <select disabled="[[ unloaded ]]" hidden="[[ !select ]]"></select>
    </template>
    <script>
        class MyScriptLanguagesElement extends Polymer.Element {

            static get is() {
                return 'myscript-languages-element';
            }

            static get properties() {
                return {
                    /**
                     * <b>not mutable</b><br />
                     * The current recognition type (e.g. TEXT or ANALYZER)
                     */
                    type: {
                        type: String,
                        reflectToAttribute: true,
                        value: 'TEXT'
                    },
                    /**
                     * Scheme to use to connect to MyScript Cloud or Server. (https or http)
                     */
                    scheme: {
                        type: String,
                        reflectToAttribute: true,
                        value: 'https'
                    },
                    /**
                     * The current recognition service host.
                     */
                    host: {
                        type: String,
                        reflectToAttribute: true,
                        value: 'cloud.myscript.com'
                    },
                    /**
                     * Application key to use for recognition on MyScript handwriting recognition server.<br />
                     * You have to create your own MyScript Developer account at http://dev.myscript.com and then generate your application key at http://cloud.myscript.com. See the Developer Guide to learn how to register.<br /><br />
                     * <b>Warning</b>: This parameter is <b>mandatory</b> and its value should be a string.
                     */
                    applicationkey: {
                        type: String,
                        reflectToAttribute: true
                    },
                    /**
                     * Language list sorts by values parameter. If false, language list sort by canonical name
                     */
                    sortbyvalue: {
                        type: Boolean,
                        reflectToAttribute: true,
                        value: true
                    },
                    /**
                     * Languages List
                     */
                    languages: {
                        type: Array,
                        value: [],
                        notify: true
                    },
                    /**
                     * Properties to set when you wish to set attributes in javascript. unloaded attributes should be removed once all properties are set.
                     * (see demo/get_languages_programmatic.html for a better understanding)
                     */
                    unloaded: {
                        type: Boolean,
                        value: true,
                        notify: true,
                        reflectToAttribute: true,
                        observer: '_unloadedChanged'
                    },
                    /**
                     * Set the additional configuration used to feed MyScript ink Paper (Structure of object as defined in MyScriptjs MyScriptJSOptions.js file)
                     * Configuration values are taken into account when myscript-common-element is attach to the dom and when unloaded is set to false.
                     * Configuration values are not reflected to myscript-languages-element attributes plus attributes values are always taken into account before configuration values (see demo/programmatic_init.html for a better understanding).
                     */
                    configuration: {
                        type: Object,
                        notify: true
                    },
                    /**
                     * True to display console output, false otherwise.
                     */
                    debug: {
                        type: Boolean,
                        value: false,
                        reflectToAttribute: true
                    },
                    /**
                     * If set to true, display the language select.
                     */
                    select: {
                        type: Boolean,
                        reflectToAttribute: true,
                        value: false,
                        notify: true
                    }
                }
            }

            connectedCallback() {
                super.connectedCallback();

                this.logger = MyScript.LoggerConfig.getLogger('languages-element');
                this.logger.setLevel(this.debug ? 'DEBUG' : 'ERROR', false);
                this.logger.info('attached callback');

                this.selectElement = this.shadowRoot.querySelector('select');

                this._selectHandler = (e) => {
                    const selected = this.languages
                        .filter(language => language.value === e.target.value);
                    this.dispatchEvent(new CustomEvent('select', { detail: selected.length > 0 ? selected[0] : undefined }));
                };

                this.selectElement.addEventListener('change', this._selectHandler);
                this.connected = true;
                this._unloadedChanged(this.unloaded);
            }

            disconnectedCallback() {
                super.disconnectedCallback();
                this.selectElement.removeEventListener('change', this._selectHandler);
            }

            _unloadedChanged(unloaded) {
                if (this.connected === true && unloaded === true) {
                    this.logger.trace('unloaded changed', unloaded);
                    this._getLanguages();
                }
            }

            _buildConfiguration() {
                if (!this.configuration) {
                    this.configuration = {};
                }
                this.configuration.recognitionTriggerDelay = this.recognitiontriggerdelay;
                this.configuration.recognitionProcessDelay = this.recognitionprocessdelay;
                if (this.protocol === 'REST') {
                    this.configuration.recognitionTriggerOn = 'QUIET_PERIOD';
                } else {
                    this.configuration.recognitionTriggerOn = 'POINTER_UP';
                }
                if (!this.configuration.recognitionParams) {
                    this.configuration.recognitionParams = {};
                }
                this.configuration.recognitionParams.type = this.type;
                this.configuration.recognitionParams.protocol = this.protocol;
                this.configuration.recognitionParams.apiVersion = this.apiversion;
                if (!this.configuration.recognitionParams.server) {
                    this.configuration.recognitionParams.server = {};
                }
                this.configuration.recognitionParams.server.scheme = this.scheme;
                this.configuration.recognitionParams.server.host = this.host;
                this.configuration.recognitionParams.server.applicationKey = this.applicationkey;
                this.configuration.recognitionParams.server.hmacKey = this.hmackey;
                this.configuration.recognitionParams.server.scheme = this.scheme;
                return this.configuration;
            }

            _getConfigurationLanguageCode() {
                if (this.configuration.recognitionParams.apiVersion === 'V4') {
                    return this.configuration.recognitionParams.v4.lang;
                } else if (this.configuration.recognitionParams.apiVersion === 'V3') {
                    switch (this.configuration.recognitionParams.type) {
                        case 'TEXT':
                            return this.configuration.recognitionParams.v3.textParameter.language;
                        case 'ANALYZER':
                            return this.configuration.recognitionParams.v3.analyzerParameter.textParameter.language;
                        default:
                            return undefined;
                    }
                }
                return undefined;
            }

            _getLanguages() {
                MyScript.getAvailableLanguageList(this._buildConfiguration(), this.sortbyvalue)
                    .then((res) => {
                        this.languages = Object
                            .keys(res.result)
                            .map((key) => {
                                return { 'value': key, 'description': res.result[key] };
                            });
                        this.unloaded = false;

                        const currentLanguage = this._getConfigurationLanguageCode();
                        this.languages.forEach((language) => {
                            const selected = currentLanguage === language.value;
                            this.selectElement.options[this.selectElement.options.length] = new Option(language.description, language.value, selected, selected)
                        });
                        this.selectElement.disabled = false;
                        this.dispatchEvent(new CustomEvent('change', { detail: this.languages }));
                        return this.languages;
                    })
                    .catch((err) => {
                        this.languages = [];
                        this.unloaded = false;
                        this.dispatchEvent(new CustomEvent('error', { detail: err }));
                    });
            }

        }
        customElements.define(MyScriptLanguagesElement.is, MyScriptLanguagesElement);
    </script>
</dom-module>

<!--
Copyright Â© MyScript.
LICENSE: [Apache License 2.0](http://www.apache.org/licenses/LICENSE-2.0)
-->
<link rel="import" href="../polymer/polymer.html">

<dom-module id="myscript-languages-element">
    <script src="../myscript/dist/myscript.min.js"></script>
    <script>

        /**
         * Uncomment the function body during development. Should not be activated in production.
         * @param string
         * @param object
         * @constructor
         */
        function LOG(string, object) {
            if (object) {
                console.log(string, object);
            } else {
                console.log(string);
            }
        }

        /**
         * Build the configuration to pass to editor.
         * @param languagesElement
         * @returns {{}}
         */
        function buildLanguagesConfiguration(languagesElement) {
            if (!languagesElement.configuration) {
                languagesElement.configuration = {};
            }
            languagesElement.configuration.recognitionTriggerDelay = languagesElement.recognitiontriggerdelay;
            languagesElement.configuration.recognitionProcessDelay = languagesElement.recognitionprocessdelay;
            if (languagesElement.protocol === 'REST') {
                languagesElement.configuration.recognitionTriggerOn = 'QUIET_PERIOD';
            } else {
                languagesElement.configuration.recognitionTriggerOn = 'POINTER_UP';
            }
            if (!languagesElement.configuration.recognitionParams) {
                languagesElement.configuration.recognitionParams = {};
            }
            languagesElement.configuration.recognitionParams.type = languagesElement.type;
            languagesElement.configuration.recognitionParams.protocol = languagesElement.protocol;
            languagesElement.configuration.recognitionParams.apiVersion = languagesElement.apiversion;
            if (!languagesElement.configuration.recognitionParams.server) {
                languagesElement.configuration.recognitionParams.server = {};
            }
            languagesElement.configuration.recognitionParams.server.scheme = languagesElement.scheme;
            languagesElement.configuration.recognitionParams.server.host = languagesElement.host;
            languagesElement.configuration.recognitionParams.server.applicationKey = languagesElement.applicationkey;
            languagesElement.configuration.recognitionParams.server.hmacKey = languagesElement.hmackey;
            languagesElement.configuration.recognitionParams.server.scheme = languagesElement.scheme;
            return languagesElement.configuration;
        }

        /**
         * Attach the element to the dom. This is the most critical part of the component.
         * @param languagesElement
         */
        function getLanguages(languagesElement) {
            languagesElement.configuration = buildLanguagesConfiguration(languagesElement);

            MyScript.getAvailableLanguageList(languagesElement.configuration, languagesElement.sortbyvalue).then(function (res) {
                languagesElement.languages = [];
                Object.keys(res.result).forEach(function (key) {
                    languagesElement.languages.push({ 'value': key, 'description': res.result[key] });
                });
                languagesElement.dispatchEvent(new CustomEvent('myscript-languages-element-result', { detail: languagesElement.languages }));
            });
        }


        Polymer({
                    is: 'myscript-languages-element',
                    /**
                     * Fired when a languages list is successfully received.
                     *
                     * @event myscript-languages-element-result
                     */
                    properties: {
                        /**
                         * <b>not mutable</b><br />
                         * The current recognition type (e.g. TEXT or ANALYZER)
                         * @default 'TEXT'
                         */
                        type: {
                            type: String,
                            reflectToAttribute: true,
                            value: 'TEXT'
                        },
                        /**
                         * Scheme to use to connect to MyScript Cloud or Server. (https or http)
                         * @private
                         * @type Boolean
                         * @default true
                         */
                        scheme: {
                            type: String,
                            reflectToAttribute: true,
                            value: 'https'
                        },
                        /**
                         * The current recognition service host.
                         * @type String
                         * @default 'cloud.myscript.com'
                         */
                        host: {
                            type: String,
                            reflectToAttribute: true,
                            value: 'cloud.myscript.com'
                        },
                        /**
                         * Application key to use for recognition on MyScript handwriting recognition server.<br />
                         * You have to create your own MyScript Developer account at http://dev.myscript.com and then generate your application key at http://cloud.myscript.com. See the Developer Guide to learn how to register.<br /><br />
                         * <b>Warning</b>: This parameter is <b>mandatory</b> and its value should be a string.
                         * @type String
                         */
                        applicationkey: {
                            type: String,
                            reflectToAttribute: true
                        },
                        /**
                         * Language list sorts by values parameter. If false, language list sort by canonical name
                         */
                        sortbyvalue: {
                            type: Boolean,
                            reflectToAttribute: true,
                            value: true
                        },
                        /**
                         * Languages List
                         */
                        languages: {
                            type: Object,
                            notify: true
                        },
                        /**
                         * Properties to set when you wish to set attributes in javascript. unloaded attributes should be removed once all properties are set.
                         * (see demo/languages-selector-init.html for a better understanding)
                         */
                        unloaded: {
                            type: Boolean,
                            value: false,
                            notify: true,
                            reflectToAttribute: true,
                            observer: 'unloadedChanged'
                        },
                        /**
                         * Set the additional configuration used to feed MyScript ink Paper (Structure of object as defined in MyScriptjs MyScriptJSOptions.js file)
                         * Configuration values are taken into account when myscript-common-element is attach to the dom and when unloaded is set to false.
                         * Configuration values are not reflected to myscript-languages-element attributes plus attributes values are always taken into account before configuration values (see demo/programmatic-init.html for a better understanding).
                         */
                        configuration: {
                            type: Object,
                            notify: true
                        }
                    },
                    unloadedChanged: function (unloaded) {
                        LOG('languages-element unloaded changed', unloaded);
                        if (this.connected === true && unloaded !== true) {
                            getLanguages(this);
                        }
                    },
                    // Will be renamed connected with pure custom element support
                    attached: function () {
                        LOG('languages-element attached callback');
                        getLanguages(this);
                        this.connected = true;
                    }
                }
        );
    </script>
</dom-module>
